name: MCP Server Validation

on:
  push:
    branches: [ main, develop, copilot/** ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  validate-mcp:
    name: Validate MCP Server Tools
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Verify MCP server file exists
        run: |
          if [ ! -f scripts/kryptotrac-mcp.js ]; then
            echo "❌ MCP server file not found at scripts/kryptotrac-mcp.js"
            exit 1
          fi
          echo "✅ MCP server file found"

      - name: Make MCP server executable
        run: chmod +x scripts/kryptotrac-mcp.js

      - name: Test MCP server startup
        run: |
          echo "Testing MCP server startup..."
          timeout 5 node scripts/kryptotrac-mcp.js &
          sleep 2
          echo "✅ MCP server starts successfully"

      - name: Test check_bb_status tool
        id: test_bb_status
        run: |
          echo "Testing check_bb_status tool..."
          response=$(echo '{"tool":"check_bb_status"}' | node scripts/kryptotrac-mcp.js | grep '"tool":"check_bb_status"')
          if [ -z "$response" ]; then
            echo "❌ check_bb_status tool failed to respond"
            exit 1
          fi
          
          # Validate JSON
          echo "$response" | python3 -m json.tool > /dev/null 2>&1
          if [ $? -ne 0 ]; then
            echo "❌ check_bb_status returned invalid JSON"
            echo "Response: $response"
            exit 1
          fi
          
          echo "✅ check_bb_status tool passed"
          echo "Response: $response"

      - name: Test read_personas tool
        id: test_personas
        run: |
          echo "Testing read_personas tool..."
          response=$(echo '{"tool":"read_personas"}' | node scripts/kryptotrac-mcp.js | grep '"tool":"read_personas"')
          if [ -z "$response" ]; then
            echo "❌ read_personas tool failed to respond"
            exit 1
          fi
          
          # Validate JSON
          echo "$response" | python3 -m json.tool > /dev/null 2>&1
          if [ $? -ne 0 ]; then
            echo "❌ read_personas returned invalid JSON"
            echo "Response: $response"
            exit 1
          fi
          
          echo "✅ read_personas tool passed"
          echo "Response: $response"

      - name: Test check_atlas_routes tool
        id: test_atlas_routes
        run: |
          echo "Testing check_atlas_routes tool..."
          response=$(echo '{"tool":"check_atlas_routes"}' | node scripts/kryptotrac-mcp.js | grep '"tool":"check_atlas_routes"')
          if [ -z "$response" ]; then
            echo "❌ check_atlas_routes tool failed to respond"
            exit 1
          fi
          
          # Validate JSON
          echo "$response" | python3 -m json.tool > /dev/null 2>&1
          if [ $? -ne 0 ]; then
            echo "❌ check_atlas_routes returned invalid JSON"
            echo "Response: $response"
            exit 1
          fi
          
          echo "✅ check_atlas_routes tool passed"
          echo "Response: $response"

      - name: Test read_logs tool
        id: test_logs
        run: |
          echo "Testing read_logs tool..."
          response=$(echo '{"tool":"read_logs"}' | node scripts/kryptotrac-mcp.js | grep '"tool":"read_logs"')
          if [ -z "$response" ]; then
            echo "❌ read_logs tool failed to respond"
            exit 1
          fi
          
          # Validate JSON
          echo "$response" | python3 -m json.tool > /dev/null 2>&1
          if [ $? -ne 0 ]; then
            echo "❌ read_logs returned invalid JSON"
            echo "Response: $response"
            exit 1
          fi
          
          echo "✅ read_logs tool passed"
          echo "Response: $response"

      - name: Test invalid tool handling
        run: |
          echo "Testing invalid tool handling..."
          response=$(echo '{"tool":"invalid_tool"}' | node scripts/kryptotrac-mcp.js | grep '"error"')
          if [ -z "$response" ]; then
            echo "❌ Server did not handle invalid tool properly"
            exit 1
          fi
          
          echo "✅ Invalid tool handling passed"
          echo "Response: $response"

      - name: Test malformed JSON handling
        run: |
          echo "Testing malformed JSON handling..."
          response=$(echo 'not valid json' | node scripts/kryptotrac-mcp.js | grep '"error"')
          if [ -z "$response" ]; then
            echo "❌ Server did not handle malformed JSON properly"
            exit 1
          fi
          
          echo "✅ Malformed JSON handling passed"

      - name: Comprehensive tool validation
        run: |
          echo "Running comprehensive tool validation..."
          
          # Create a test script
          cat > /tmp/test-mcp.sh << 'EOF'
          #!/bin/bash
          set -e
          
          TOOLS=("check_bb_status" "read_personas" "check_atlas_routes" "read_logs")
          PASSED=0
          FAILED=0
          
          for tool in "${TOOLS[@]}"; do
            echo "----------------------------------------"
            echo "Testing: $tool"
            
            full_output=$(echo "{\"tool\":\"$tool\"}" | node scripts/kryptotrac-mcp.js)
            response=$(echo "$full_output" | grep "\"tool\":\"$tool\"" || true)
            
            if [ -n "$response" ]; then
              # Check if response is valid JSON
              if echo "$response" | python3 -m json.tool > /dev/null 2>&1; then
                echo "✅ $tool: PASSED"
                echo "   Response: $response"
                PASSED=$((PASSED + 1))
              else
                echo "❌ $tool: FAILED (Invalid JSON)"
                echo "   Response: $response"
                FAILED=$((FAILED + 1))
              fi
            else
              echo "❌ $tool: FAILED (No response)"
              FAILED=$((FAILED + 1))
            fi
          done
          
          echo "========================================"
          echo "Results: $PASSED passed, $FAILED failed"
          echo "========================================"
          
          if [ $FAILED -gt 0 ]; then
            exit 1
          fi
          EOF
          
          chmod +x /tmp/test-mcp.sh
          /tmp/test-mcp.sh

      - name: Generate validation report
        if: always()
        run: |
          echo "## MCP Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ All MCP tools validated successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tools Tested:" >> $GITHUB_STEP_SUMMARY
          echo "- check_bb_status" >> $GITHUB_STEP_SUMMARY
          echo "- read_personas" >> $GITHUB_STEP_SUMMARY
          echo "- check_atlas_routes" >> $GITHUB_STEP_SUMMARY
          echo "- read_logs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Validation Date:" >> $GITHUB_STEP_SUMMARY
          echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: Final status
        run: |
          echo "========================================="
          echo "✅ MCP Server Validation Complete"
          echo "========================================="
          echo "All tools are functioning correctly!"
          echo "Documentation: docs/mcp/README.md"
